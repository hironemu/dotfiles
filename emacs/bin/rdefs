#!/usr/bin/env ruby
#
# $Id$

# 不要だったり、utf-8 が不適切なら調整すること
Encoding.default_external = Encoding::UTF_8 if RUBY_VERSION =~ /1.9/

require 'optparse'

GROUP_RE = /\A\s*(?: describe\s | context\s)/x

DEF_RE = /\A\s*
  (?: it\s
    | describe\s
    | context\s
    | shared_examples_for\s
    | it_should_behave_like\s
    )/x

def main
  re = DEF_RE
  print_line_number_p = false
  parser = OptionParser.new
  parser.banner = "#{File.basename($0)} [-n] [file...]"
  parser.on('--group', 'Show only "describe" and "context"') {
    re = GROUP_RE
  }
  parser.on('-n', '--lineno', 'Prints line number.') {
    print_line_number_p = true
  }
  parser.on('--help', 'Prints this message and quit.') {
    puts parser.help
    exit 0
  }
  begin
    parser.parse!
  rescue OptionParser::ParseError => err
    $stderr.puts err.message
    exit 1
  end

  f = Preprocessor.new(ARGF)
  while line = f.gets
    if re =~ line
      printf '%4d: ', f.lineno if print_line_number_p
      print getdef(line, f)
    end
  end
end

def getdef(str, f)
  until balanced?(str)
    line = f.gets
    break unless line
    str << line
  end
  str
end

def balanced?(str)
  s = str.gsub(/'.*?'/, '').gsub(/".*?"/, '')
  s.count('(') == s.count(')')
end

class Preprocessor
  def initialize(f)
    @f = f
  end

  def gets
    line = @f.gets
    if /\A=begin\s/ =~ line
      while line = @f.gets
        break if /\A=end\s/ =~ line
      end
      line = @f.gets
    end
    line
  end

  def lineno
    @f.lineno
  end
end

main
